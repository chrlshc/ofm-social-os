# pgBackRest Configuration for OFM Social OS
# Point-in-Time Recovery (PITR) with S3 storage and lifecycle management

[global]
# Repository configuration for S3
repo1-type=s3
repo1-s3-bucket=ofm-social-backups
repo1-s3-region=us-east-1
repo1-s3-endpoint=s3.amazonaws.com
repo1-s3-key=${AWS_ACCESS_KEY_ID}
repo1-s3-key-secret=${AWS_SECRET_ACCESS_KEY}
repo1-s3-ca-file=/etc/ssl/certs/ca-certificates.crt
repo1-s3-verify-tls=y

# Repository path structure
repo1-path=/backup/db
repo1-retention-full=4
repo1-retention-diff=4
repo1-retention-archive=7

# Compression and encryption
repo1-bundle=y
repo1-block=y
compress-type=lz4
compress-level=6

# Archive configuration
archive-async=y
archive-get-queue-max=128GB
archive-push-queue-max=128GB

# Process configuration
process-max=4
log-level-console=info
log-level-file=detail
log-path=/var/log/pgbackrest
log-timestamp=y

# Buffer sizes for performance
buffer-size=64MB
db-timeout=1800
protocol-timeout=1800

# Start fast on errors
start-fast=y

# Database cluster configuration
[db]
pg1-path=${PGDATA:-/var/lib/postgresql/data}
pg1-port=${PGPORT:-5432}
pg1-user=${PGUSER:-postgres}
pg1-database=${PGDATABASE:-postgres}

# Socket path for local connections
pg1-socket-path=/var/run/postgresql

# Recovery configuration
recovery-option=standby_mode=on
recovery-option=primary_conninfo=host=localhost port=5432 user=postgres
recovery-option=recovery_target_timeline=latest

# Backup configuration
backup-standby=n